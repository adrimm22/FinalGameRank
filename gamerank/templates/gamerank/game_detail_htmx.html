{% extends "gamerank/base.html" %}
{% block content %}

<h2 class="section-title mt-4">{{ game.title }} (HTMX Dynamic Mode)</h2>

<form method="POST" action="{% url 'game_detail' game.game_id %}" class="mb-4">
    {% csrf_token %}
    {% if followed %}
        <button type="submit" name="unfollow" class="btn btn-outline-danger btn-sm">Unfollow Game</button>
    {% else %}
        <button type="submit" name="follow" class="btn btn-outline-success btn-sm">Follow Game</button>
    {% endif %}
</form>

<div class="row mb-5">
    <div class="col-md-8">
        <p><strong>Genre:</strong> {{ game.genre }}</p>
        <p><strong>Platform:</strong> {{ game.platform }}</p>
        <p><strong>Developer:</strong> {{ game.developer }}</p>
        <p><strong>Publisher:</strong> {{ game.publisher }}</p>
        <p><strong>Release Date:</strong> {{ game.release_date }}</p>
        <p><strong>Description:</strong> {{ game.short_description }}</p>
        {% if game.game_url %}
            <a href="{{ game.game_url }}" target="_blank" class="btn btn-primary">Play Now</a>
        {% endif %}
    </div>
    <div class="col-md-4">
        {% if game.thumbnail %}
            <img src="{{ game.thumbnail }}" class="img-fluid rounded" alt="Game Image">
        {% endif %}
    </div>
</div>

<h3 class="mt-5">Your Rating</h3>

{% if user_rating %}
    <p>
        You have rated this game:
        <i class="fas fa-star text-warning"></i> {{ user_rating.vote }}
        <small>({{ user_rating.vote }}/5)</small>
    </p>
{% else %}
    <form method="POST" action="{% url 'game_detail' game.game_id %}" class="mb-4">
        {% csrf_token %}
        <label for="voteSelect" class="form-label">Select a score:</label>
        <select id="voteSelect" name="vote" class="form-select w-auto d-inline-block" required>
            <option value="">-- Choose --</option>
            {% for n in rating_range %}
                <option value="{{ n }}">{{ n }}</option>
            {% endfor %}
        </select>
        <button type="submit" class="btn btn-sm btn-success">Rate</button>
    </form>
{% endif %}

<hr class="my-5">

<div class="card mb-4">
    <div class="card-body">
        <h5 class="card-title">Write a comment</h5>

        <form
            id="form-comentario"
            hx-post="{% url 'post_comment_htmx' game.game_id %}"
            hx-target="#nuevo-comentario"
            hx-swap="beforebegin"
            hx-on="htmx:afterRequest: this.reset()"
        >
            {% csrf_token %}
            <div class="mb-3">
                <textarea name="comment_text" class="form-control" rows="3" required></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Post</button>
        </form>
    </div>
</div>

<div id="nuevo-comentario"></div>

<h3>Recent Comments</h3>

<div
    hx-get="{% url 'comments_htmx' game.game_id %}"
    hx-trigger="load, every 30s"
    hx-target="#lista-comentarios"
    hx-swap="innerHTML"
></div>

<div id="lista-comentarios">
    {% include "gamerank/includes/comments_htmx.html" %}
</div>

<a href="{% url 'home' %}" class="btn btn-secondary mt-4">‚Üê Back</a>

<div class="mt-3">
    <a href="{% url 'game_detail' game.game_id %}" class="btn btn-outline-secondary btn-sm">
        View traditional mode
    </a>
</div>

{% endblock %}